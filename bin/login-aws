#!/bin/bash

if [[ $(uname -n) == dev-dsk* ]]; then
	# Step 1. Generate Midway cookie and Kerberos ticket
	echo "Generating Midway cookie and Kerberos ticket..."
	mwinit -s -o && kinit -R
	kinitmonday() { kinit -f -r 7d; }
	if ! klist -l; then kinitmonday; fi

	# Step 2. Log in to CodeArtifact
	echo -e "\nLogging in to CodeArtifact..."
	aws codeartifact login --profile fed-dev-admin --tool npm --domain amazon --repository federate --domain-owner 149122183214 --region us-west-2
else
	# Step 1. Connect to VPN
	vpncli=/opt/cisco/anyconnect/bin/vpn
	if $vpncli -s state | grep -iq 'disconnect'; then
		pkill -x "Cisco AnyConnect Secure Mobility Client"
		echo "Connecting to VPN..."
		read -rep "PIN for $(whoami): " -s pin
		read -rep $'\nPress the button on your YubiKey (you might have to hold it for about 3-5 seconds before your token produces a one-time password)...\n' -s otp

		printf "\n\n$pin$otp" | $vpncli -s connect "Automatic Selection (Route53)"
	else
		echo "VPN Connected"
	fi

	# Step 2. Midway
	echo "Generating Midway cookie..."
	mwinit -o

	# Step 3. SSH into Cloud Desktop
	ssh devdesk
fi
